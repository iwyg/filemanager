(function(a,b){a("fm_settings",[],function(){return{root:b.Context.get("root"),instances:{}}})})(this.define,this.Symphony),function(a){a("collections/col_general",["underscore","backbone"],function(a,b){var c=b.Collection.extend({addSetting:function(a,b,c){this.settings=this.settings||{};if(this.settings[a]&&c!==!0)throw"setting "+a+"already defined";this.settings[a]=b;return this}});c.defaults={};return c})}(this.define),function(a,b,c){typeof b=="function"&&b.amd?b("plugins/jquery-iframe-transport/jquery-iframe-transport",["jquery"],c):c(a.jQuery)}(this,this.define,function(a,b){a.ajaxPrefilter(function(a,b,c){if(a.iframe)return"iframe"}),a.ajaxTransport("iframe",function(b,c,d){function j(){i.replaceWith(function(a){return h.get(a)}),e.remove(),f.attr("src","javascript:false;").remove()}var e=null,f=null,g="iframe-"+a.now(),h=a(b.files).filter(":file:enabled"),i=null;b.dataTypes.shift();if(h.length){e=a('<form enctype="multipart/form-data" method="post"></form>').hide().attr({action:b.url,target:g}),typeof b.data=="string"&&b.data.length>0&&a.error("data must not be serialized"),a.each(b.data||{},function(b,c){a.isPlainObject(c)&&(b=c.name,c=c.value),a('<input type="hidden">').attr({name:b,value:c}).appendTo(e)}),a('<input type="hidden" value="IFrame" name="X-Requested-With">').appendTo(e),i=h.after(function(b){return a(this).clone().prop("disabled",!0)}).next(),h.appendTo(e);return{send:function(b,c){f=a('<iframe src="javascript:false;" name="'+g+'" style="display:none"></iframe>'),f.bind("load",function(){f.unbind("load").bind("load",function(){var a=this.contentWindow?this.contentWindow.document:this.contentDocument?this.contentDocument:this.document,b=a.documentElement?a.documentElement:a.body,d=b.getElementsByTagName("textarea")[0],e=d?d.getAttribute("data-type"):null,f={html:b.innerHTML,text:e?d.value:b?b.textContent||b.innerText:null};j(),c(200,"OK",f,e?"Content-Type: "+e:null)}),e[0].submit()}),a("body").append(e,f)},abort:function(){f!==null&&(f.unbind("load").attr("src","javascript:false;"),j())}}}})}),function(a,b,c){var d={xhrFileUpload:!!a.XMLHttpRequestUpload&&!!a.FileReader,xhrFormDataFileUpload:!!a.FormData},e={cache:!1,type:"POST",processData:!1,contentType:!1},f=d.xhrFormDataFileUpload;b("modules/mod_async_upload",["jquery","underscore","backbone","plugins/jquery-iframe-transport/jquery-iframe-transport"],function(b,c,d){function o(){this.initialize.apply(this,arguments)}var g,h=function(a){var b=a.find("form"),c=b.length;a.get(0).nodeName.toLowerCase()!=="form"||!c?a=a.find("input, textarea, select"):c&&(a=b);return a.serializeArray()},i=function(){return f?function(d){var e=new a.FormData;c.each(d,function(d,f,g){d instanceof a.Blob?e.append(f+"[]",d,f.name):d instanceof b&&c.each(h(d),function(a){e.append(a.name,a.value)})});return e}:function(a){var b=h(a.context);b.push({name:"iframe",value:!0});return b}}(),j=function(a){var b=a.originalEvent,c=b.total||b.totalSize,d=b.loaded;this.trigger("progress",d,c)},k=function(){var a=b.ajaxSettings.xhr();a.upload&&b(a.upload).on("progress",c.bind(j,this));return a},l=function(){return f?function(b){if(!!b.file&&b.file instanceof a.Blob){!b.file.name&&b.file.fileName&&(b.file.name=b.file.fileName),!b.file.size&&b.file.fileSize&&(b.file.size=b.file.fileSize);return b}throw"no file found"}:function(a){return a}}(),m=function(a){return c.extend({url:this.settings.url,data:i(l(a)),xhr:c.bind(k,this)},g.defaults)},n=function(){return f?m:function(a){var b=a.form;a=m.call(this,a),a.files=b,a.iframe=!0,a.dataType="iframe json";return a}}();o.prototype.initialize=function(){},c.extend(o.prototype,d.Events),o.extend=d.Model.extend,g=o.extend({initialize:function(a){this.settings=c.extend(c.clone(g.defaults),a||{})},send:function(a){a=n.call(this,a);var c=b.ajax(a);return c}}),g.defaults=function(){return f?e:c.extend(e,{files:"",form:"",processData:!1})}(),g.isXHRFileUpload=f;return g})}(this,this.define),function(a){var b=1e3,c=Math.pow(b,2),d=Math.pow(b,3);a("modules/mod_byteconverter",[],function(){function h(a){return a<b?a+"":a<c?e(a)+" KB":a<d?f(a)+" MB":g(a)+" GB"}function g(b){return a(b,d)}function f(b){return a(b,c)}function e(c){return a(c,b)}function a(a,b){return(Math.round(a/b*1e5)/1e5).toFixed(2)}return h})}(this.define),function(a,b){a("collections/col_upload",["jquery","underscore","backbone","collections/col_general","modules/mod_async_upload","modules/mod_byteconverter"],function(a,c,d,e,f,g){function n(a){a===this&&this.trigger("destroyed",this)}function m(a){a.fail(c.bind(k,this)).done(c.bind(l,this));return a}function l(a,b){b==="success"&&this.trigger("success",this,a)}function k(b,c){c==="abort"&&this.trigger("cancled",this),c==="error"&&this.trigger("error",this,a.parseJSON(b.responseText))}var h,i,j;i=d.Model.extend({initialize:function(){this.collection.trigger("create",this),window._m=this,this.collection.on("remove",c.bind(n,this))},parse:function(a){},url:function(){return this.collection.url+"?field_id="+this.get("field_id")},defaults:{context:"",file:[],originalFiles:[],form:"",name:undefined,size:0,type:undefined,id:undefined,field_id:undefined},_createSendData:function(){return{file:this.get("file")}},_filter:function(a,b){var d=b.split(" "),e={};c.each(a,function(a,b){c.include(d,b)&&(e[b]=a)});return e},send:function(){var a=new f({url:this.url()});a.on("progress",c.bind(this._onProgress,this)),this._upload=m.call(this,a.send(this._filter(this.toJSON(),"file context form")))},_onProgress:function(a,b){this.trigger("progress",Math.floor(a/b*100))},_onSuccess:function(){}}),j=function(){function p(a){alert(a)}function o(a){!a.name&&a.fileName&&(a.name=a.fileName),!a.size&&a.fileSize&&(a.size=a.fileSize);return a}function n(b){a[this.cid].push(b),this.trigger("push")}function m(a){d[this.cid].push(a),this.trigger("push")}function l(a){var b=d[this.cid],e=c.indexOf(b,a);e>-1&&(b.splice(e,1),this.trigger("flush"))}function k(b){var d=a[this.cid],e=c.indexOf(d,b);e>-1&&(d.splice(e,1),this._uploads--,this.trigger("flush"))}function j(a){var b=this,d=[],e=c.toArray(a[0].files);e.length||e.push({name:a[0].value.replace(/^.*\\/,"")}),c.each(e,function(i,j,k){var l=c.clone(b.model.prototype.defaults);i.type&&!f.call(b,i.type)?(e[j]=null,e.splice(j,1),b.trigger("invalidtype",i.name||i.fileName,i.type)):i.size&&!h.call(b,i.size)?(e[j]=null,e.splice(j,1),b.trigger("filesizeexceeds",i.name||i.fileName,i.size)):(l.form=a,l.file=i,l.originalFiles=k,l.name=i.name||i.fileName,l.size=g(i.size||i.fileSize),l.type=i.type,l.id=c.uniqueId(),d.push(l))});return d}function h(a){return parseInt(this.settings.max_file_size,10)<a?!1:!0}function f(a){return a.match(this.settings.allowed_types)?!0:!1}var a={},d={};return e.extend({events:{error:"_onError"},initialize:function(){this.cid=this.cid||"c"+c.uniqueId(),d[this.cid]=[],a[this.cid]=[],this.on("add",c.bind(n,this)),this.on("remove",c.bind(k,this))},url:b.Context.get("root")+"/symphony/extension/filemanager/upload/",model:i,addItem:function(a){var b=j.call(this,a);this.add(b)},removeItem:function(a){this.remove(a)},update:function(a,b){var d=this,e;c.isArray(b)?c.each(b,function(b){d.update(a,b)}):(e=this.get(a),e.set(b))},send:function(a){var b=this.get(a),d;b.on("success",c.bind(this.update,this)).on("success error cancled",c.bind(l,this)),d=b.send(),m.call(this,b),k.call(this,b);return b._upload},cancel:function(a){var b=this.get(a);if(b._upload&&!b._upload.isResolved()){b._upload.abort(),n.call(this,b);return!0}return!1},hasActiveUploads:function(){return!!d[this.cid].length},hasPendingUploads:function(){return!!a[this.cid].length}})}(),h=e.extend({constructors:{UploadList:j},addList:function(){var a=new j;c.each(this.settings,function(b,c){a.addSetting(c,b,!0)});return a},initialize:function(){this.settings=c.extend({},h.defaults)}}),h.defaults={field_id:null,allowed_types:["image/jpeg"]};return new h})}(this.define,this.Symphony),function(a,b){var c=Math.PI,d=c*2,e=c/2;b("modules/mod_animate_circle",["jquery","underscore"],function(a,b){function k(a){this.settings=b.extend(b.clone(k.defaults),a||{}),this.canvas=this.settings.canvas,this.ctx=this.canvas.getContext("2d"),this._begin=-e,this._cw=this.canvas.width,this._ch=this.canvas.height,this._last=[0],this._ao=jQuery({p:0}),this._calcColDiff(),this.ctx.arc(this._cw/2,this._ch/2,this._ch/2-this.settings.lineWidth,0,d,!1);var c=this._ch/2,f=c-this.settings.lineWidth;this._grad=this.ctx.createRadialGradient(c,c,f,c,c,c),j.call(this,[220,220,220]),this.ctx.beginPath(),this.ctx.lineWidth=this.settings.lineWidth,this.ctx.strokeStyle=this._grad,this.ctx.closePath(),this.ctx.fill(),this.ctx.arc(this._cw/2,this._ch/2,this._ch/2-this.settings.lineWidth/2,-e,100-e,!1),this.ctx.stroke(),this._imd=this.ctx.getImageData(0,0,this._cw,this._ch)}function j(a){var b=this._ch/2,c=b-this.settings.lineWidth;this._grad=this.ctx.createRadialGradient(b,b,c,b,b,b),this._grad.addColorStop(0,i(g(a,10))),this._grad.addColorStop(.3,i(a)),this._grad.addColorStop(.7,i(a)),this._grad.addColorStop(1,i(g(a,10)))}function i(a){var b=a.length>3?"rgba(":"rgb(";return b+a.join(",")+")"}function h(a,b){var c=a[0],d=a[1],e=a[2],g=f(b,c),h=f(b,d),i=f(b,e);return[g,h,i]}function g(a,b){var d=a[0],e=a[1],f=a[2],g=c(b,d),h=c(b,e),i=c(b,f);return[g,h,i]}function f(a,b){return Math.min(Math.round((b/255*100+a)/100*255),255)}function c(a,b){return Math.max(Math.round((b/255*100-a)/100*255),0)}k.prototype={_prop:function(a){return{p:a}},_complete:function(a){typeof a=="function"&&setTimeout(a,0)},drawFullCircle:function(a){j.call(this,a),this.ctx.putImageData(this._imd,0,0),this.ctx.strokeStyle=this._grad,this.ctx.arc(this._cw/2,this._ch/2,this._ch/2-this.settings.lineWidth/2,-e,100-e,!1),this.ctx.stroke(),this.ctx.closePath()},clearAnimation:function(){this._ao.stop(),this._ao.dequeue()},animate:function(a,c){this._ao[0].p=this._last.pop()||0,this._ao.stop().animate(this._last.push(a)&&this._prop(a),{duration:this.settings.stepTime,step:b.bind(this._step,this),complete:b.bind(this._complete,this,c)})},_step:function(a){var b=d/100*a;this._draw(b,this._getCurrentColor(a))},_draw:function(a,b){if(a!==0&&a===this._begin||a>=d){this.clearAnimation();return!1}j.call(this,this._cCol),this.ctx.putImageData(this._imd,0,0),this.ctx.beginPath(),this.ctx.strokeStyle=this._grad,this.ctx.arc(this._cw/2,this._ch/2,this._ch/2-this.settings.lineWidth/2,-e,a-e,!1),this.ctx.stroke()},_calcColDiff:function(){var a=this.settings.startColor,b=this.settings.endColor;this._colDiff=a,this._cMatrix=[],this._cCol=[],this._cMatrix[0]=(b[0]-a[0])/100,this._cMatrix[1]=(b[1]-a[1])/100,this._cMatrix[2]=(b[2]-a[2])/100},_getCurrentColor:function(a){this._cCol[0]=Math.round(this._colDiff[0]+this._cMatrix[0]*a),this._cCol[1]=Math.round(this._colDiff[1]+this._cMatrix[1]*a),this._cCol[2]=Math.round(this._colDiff[2]+this._cMatrix[2]*a);return"rgb("+this._cCol.join(",")+")"},update:function(){}},k.defaults={canvas:document.createElement("canvas"),startColor:[89,123,198],endColor:[126,222,79],background:"rgb(250, 250, 250)",stepTime:250,lineWidth:5};return k})}(this,this.define),function(a,b){var c={uploadedfile_size_exceeds:"file size ({$f_size}) limit exceeds allowed size",file_size_exceeds:"{$item} exceeds allowed size",file_type_invalid:"{$item}: filetype invalid",file_exists:"file {$file} already exists",file_move_success:"file {$item} successfully moved to {$to}",file_upload_success:"{$file} successfully uploaded",file_delete_success:"successfully deleted {$file}",dir_move_success:"directory {$item} successfully moved {$to}",directory_exists:"directory {$file} already exists",directory_created:"Directory {$dir} successfully created in {$path}",invalid_destination:"invalid destination: {$dir}",invalid_mimetype:"file type {$mimetype} not allowed",confirm_file_deletion:"Are you shure you want to delete {$file}? This step cannot be undone.",confirm_directory_deletion:"Are you shure you want to delete {$dir}? {$dir2} contains {$dircount} directories and {$filecount} files that will be deleted. This step cannot be undone.",file_select_limit_exceed:"Can't select more than {$count} files",unsaved_changes:"There are unsaved changes. Do you really want to continue?",directory_listing_error:"Cannot resolve directory structure for {$root}",dir_access_error:"Cannot access {$file}",dir_creating_error:"Failed creating Directory {$dir} in {$path}",item_move_error:"can't move {$file} to {$location}",file_delete_error:"can't delete file {$file}",dir_delete_error:"can't delete directory {$file}",root_dir_error:"can't delete or move {$dir}. {$dir2} is used by another field",count_files_found:"{$count} files found",count_file_found:"{$count} file found"},d=[],e=[],f=0,g=/\{\$.*?\}/g;a("modules/mod_sysmessage",["jquery","underscore"],function(a,g){function i(b,c,e){this._msgID=f++,e=typeof e=="boolean"?e:!0,this.type=!b&&c.status===400?"error":c.success?"success":b,this.msgObj=this.type==="success"?c.success:this.type==="error"?e?a.parseJSON(c.responseText).STATUS_ERROR.error:c.error:{},d.push(this.parseMessage()),this.displayMessage()}window._$_=a;var h={};g.each(c,function(a,b){h[a]=!1}),b.Language.add(h),i.prototype={parseMessage:function(){return b.Language.get(this.msgObj.message,this.msgObj.context)},getMessage:function(){return e[this._msgID]},displayMessage:function(){var c=d.length>1?0:4e3,f=a("#header"),g=this,h=d.shift();e.push(h),f.find(".notifier").css({display:""}),b.Message.post(h,g.type),setTimeout(function(){setTimeout(function(){b.Message.clear(g.type)},300)},c);return h}},g.extend(i,c);return i})}(this.define,this.Symphony),define("text!templates/dirtree.tpl",[],function(){return'<ul id="dir-list-root-<%= cid %>" class="dir-list-root"></ul>\n<input id="schema" type="hidden" name="set[schema]" value=""/>\n'}),define("text!templates/dirtree_error.tpl",[],function(){return'<p class="error"><%= message %></p>\n'}),define("text!templates/dirs.tpl",[],function(){return'<!--dir level <%= level %>">-->\n<% var droppable = ((settings.allow_dir_move || settings.allow_file_move) && writable) ? \' droppable\' : \'\', draggable = (settings.allow_dir_move && writable && _parent) ? \' draggable\' : \'\';%>\n\t<span class="dir-header<%=draggable%><%=droppable%>">\n\t\t<% if (settings.allow_dir_move && _parent && writable) {%>\n\t\t<span class="ui-icon move" id=" del-<%= id %>"></span>\t\n\t\t<%}%>\n\t\t<% if (!writable) {%>\n\t\t<span class="ui-icon readonly"></span>\t\n\t\t<%}%>\n\t\t<span class="dir-toggle"></span>\n\t\t<span class="ui-icon dir"></span>\n\t\t<label class="dir-label text">\n\t\t\t<%= name %>\n\t\t</label>\n\t\t<% if (settings && writable && (settings.allow_dir_upload_files || settings.allow_dir_create || settings.allow_dir_delete)) { %>\t\n\t\t<span class="toolbar">\n\t\t\t<% if (settings.allow_dir_upload_files) {%>\n\t\t\t<span class="ui-icon upload"></span>\t\n\t\t\t<%}%>\n\t\t\t<% if (settings.allow_dir_create) {%>\n\t\t\t<span class="ui-icon create"></span>\t\n\t\t\t<%}%>\n\t\t\t<% if (settings.allow_dir_delete && deletable) {%>\n\t\t\t<span class="ui-icon delete-dir delete" id="del-<%= id %>"></span>\t\n\t\t\t<%}%>\n\t\t</span>\n\t\t<%}%>\n\n\t</span>\n\t<ul id="sub-<%= id %>" class="dir sub-dir <% if (!!_parent) {%> sub-dir <%} %>">\n\t</ul>\n<!-- dir end -->\n'}),define("text!templates/newdir.tpl",[],function(){return'<li class="dir new-dir level-<%= level %>">\n\t<span class="dir-header">\n\t\t<span class="dir-toggle"></span>\n\t\t<span class="ui-icon folder"></span>\n\t\t<div class="input">\n\t\t\t<input type="text" class="cr-new-dir" name="mkdir" placeholder="enter new directory name"/>\n\t\t\t<input type="hidden" name="in" value="<%= parent %>"/>\n\t\t\t<input type="hidden" name="type" value="create"/>\n\t\t</div>\n\t\t<div class="btns">\n\t\t\t<span class="btn small add last">ok</span>\n\t\t\t<span class="btn small cancel last">cancel</span>\n\t\t</div>\n\t</span>\n</li>\n'}),define("text!templates/files.tpl",[],function(){return'<% var draggable = (settings.allow_file_move && moveable) ? \' draggable\' : \'\' %>\n<li class="file<%= draggable %>" id="file-<%= id %>">\n\t<% if (settings.allow_file_move && moveable) {%>\n\t<span class="ui-icon move" id="move-<%= id %>"></span>\t\n\t<%}%>\n\t<% if (!moveable) {%>\n\t<span class="ui-icon readonly"></span>\t\n\t<%}%>\n\t<span class="ui-icon <%= cssclass %>"></span>\n\t<span class="text" id="select-file-<%=id%>"><%= file %></span>\n\t<% if (settings) { %>\t\n\t<span class="toolbar">\n\t\t<% if (settings.allow_file_delete && moveable) {%>\n\t\t<span class="ui-icon delete-file delete" id="del-<%= id %>" title="delete file"></span>\t\n\t\t<%}%>\n\t\t<span class="ui-icon preview" id="preview-<%= id %>"></span>\t\n\t</span>\n\t<%}%>\n</li>\n'}),define("text!templates/selected_compact.tpl",[],function(){return'<% var addClass = draggable ? \' draggable\' : \'\'; %>\n<li id="item-<%= id %>" class="floatbar<%= addClass %>" >\n\t<span class="floatbar-label">\n\t\t<span class="file-name" href="<%= src %>" target="_blanc"><%= file %></span>\n\t\t<input class="file-selected" id="selected-<%= id %>" type="hidden" name="fields[<%= fieldname %>][file][]" value="<%= path %>" readonly="readonly"/>\n\t</span>\n\t<span class="btn-round remove last" id="remove-<%= id %>">×</span>\n</li>\n'}),define("text!templates/selected_preview.tpl",[],function(){return'<% var addClass = draggable ? \' draggable\' : \'\'; %>\n<li id="item-<%= id %>" class="row list-row select-item<%= addClass %>" >\n\t<div class="list-column-2">\n\t\t<div class="right-space">\n\t\t<div class="left-space">\n\t\t\t<% if(draggable) { %>\n\t\t\t<span class="ui-icon move"></span>\n\t\t\t<% } %>\n\t\t\t<img src="<%= thumb %>" height="40" width="40" alt="file-preview"/>\n\t\t</div>\n\t\t\t<span class="file-name" data-src="<%= src %>"><%= file %></span>\n\t\t\t<input  class="file-selected" id="selected-<%= id %>" type="hidden" name="fields[<%= fieldname %>][file][]" value="<%= path %>" readonly="readonly"/>\n\t\t</div>\n\t</div>\n\t<div class="list-column-2">\n\t\t<span class="btn small remove last" id="remove-<%= id %>">×</span>\n\t</div>\n</li>\n'}),define("text!templates/upload.tpl",[],function(){return'<div class="section-head">\n\t<label>Uploads</label>\n</div>\n<ul class="list-container uploads" id="uploads-<%= id %>">\n\n</ul>\t\n'}),define("text!templates/upload_list.tpl",[],function(){return'<% var breadcrump = path.split(\'/\'); breadcrump.shift(); breadcrump.shift(); breadcrump = breadcrump.join(\' > \'); %>\n<li id="upload-<%= id %>" class="upload-dir">\n<div class="breadcrump note"><%= breadcrump %></div>\n<div class="list-header">\n\t<div class="list-column-2">\n\t\t<div class="list-column-2">\n\t\t\t<div class="inner">\n\t\t\t\t<span class="btn add">\n\t\t\t\t\t<input type="file" name="file[]" value="" multiple="multiple"/>\n\t\t\t\t</span>\t\n\t\t\t\t<span class="btn remove disabled">\n\t\t\t\t</span>\t\n\t\t\t</div>\n\t\t</div>\n\t\t<div class="list-column-2">\n\t\t\t<div class="inner">\n\t\t\t\t<span class="btn start disabled">\n\t\t\t\t</span>\t\n\t\t\t\t<span class="btn cancel disabled">\n\t\t\t\t</span>\t\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\t<div class="list-column-2">\n\t\t<div class="inner">\n\t\t\t<div class="list-column-1">\n\t\t\t\t<span class="btn close last"></span>\n\t\t\t</div>\t\n\t\t</div>\n\t</div>\n</div>\n<ul class="list-container" id="upload-container-<%= id %>">\n\t<li class="hidden">\n\t\t<input type="hidden" name="destination" value="<%= destination %>"/>\n\t</li>\n</ul>\n</li>\n'}),define("text!templates/upload_list_item.tpl",[],function(){return'<li class="file-list list-row row" id="send-<%= id %>">\n\t<div class="list-column-4">\n\t\t<div class="inner">\n\t\t\t<span class="file-name pd-box">\n\t\t\t\t<% if (file === \'ok\') { %>\n\t\t\t\t<a class="success" href="<%= src %>" ><%= name %></a>\n\t\t\t\t<% } %>\n\t\t\t\t<% if (file !== \'ok\') { %>\n\t\t\t\t<%= name %>\n\t\t\t\t<% } %>\n\t\t\t</span>\n\t\t</div>\n\t</div>\n\t<div class="list-column-4">\n\t\t<div class="inner">\n\t\t\t<small class="file-size note"><%= size %></small>\n\t\t</div>\n\t</div>\n\t<div class="list-column-4">\n\t\t<div class="list-column-2">\n\t\t\t<div class="inner">\n\t\t\t\t<canvas width="36" height="36" class="progress last"></canvas>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class="list-column-2">\n\t\t\t<div class="inner">\n\t\t\t\t<span class="progress-text note"></span>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\t<div class="list-column-4">\n\t\t<div class="inner">\n\t\t\t<span class="btn small remove last">remove</span>\n\t\t\t<span class="btn small cancel disabled last">cancel</span>\n\t\t\t<span class="btn small start last">start</span>\n\t\t</div>\n\t</div>\n</li>\n\n'}),define("text!templates/meta.tpl",[],function(){return'<div class="wrapper">\n\t<div class="row bb">\n\t\t<div class="list-column-1">\n\t\t\t<span class="btn small last close">×</span>\n\t\t</div>\n\t</div>\n\t<div class="outer bt">\n\t\t<div class="row">\n\t\t\t<div class="list-column-4">\n\t\t\t\t<div class="preview-img">\n\t\t\t\t\t<img src="<%= preview %>"/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="list-column-43">\n\t\t\t\t<div class="inner">\n\t\t\t\t\t<table class="small">\n\t\t\t\t\t\t<tbody>\n\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t<td class="name">name</td>\n\t\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t\t<%= file %>\n\t\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t\t<tr class="bt">\n\t\t\t\t\t\t\t\t<td class="name">type</td>\n\t\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t\t<%= type %>\n\t\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t\t<tr class="bt">\n\t\t\t\t\t\t\t\t<td class="name">size</td>\n\t\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t\t<%= size %>\n\t\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t\t<tr class="bt">\n\t\t\t\t\t\t\t\t<td class="name">last modified</td>\n\t\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t\t<%= lastmod %>\n\t\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t</tbody>\t\n\t\t\t\t\t</table>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n</div>\n'}),define("text!templates/search_bar.tpl",[],function(){return'<div id="<%= id %>" class="search-bar">\n\t<div class="row bb bt pd-box">\n\t\t<div class="browse">\n\t\t\t<input type="text" class="search" placeholder="search…"/>\n\t\t\t<div class="result-counter"></div>\n\t\t</div>\n\t</div>\n\t<ul class="results"></ul>\n</div>\n'}),define("text!templates/search_list.tpl",[],function(){return'<% var classSelected = selected ? \' selected\' : \'\' %>\n<li id="result-<%= id %>" class="row list-row result-item file<%=classSelected%>" >\n\t<div class="list-column-2">\n\t\t<div class="right-space">\n\t\t<div class="left-space">\n\t\t\t<img src="<%= thumb %>" height="40" width="40" alt="file-preview"/>\n\t\t</div>\n\t\t\t<span class="file-name" data-src="<%= src %>"><%= file %></span>\n\t\t\t<span class="root-name"><%= dir.attributes.path %></span>\n\t\t</div>\n\t</div>\n</li>\n'}),define("text!templates/search_count.tpl",[],function(){return'<div class="search-count">\n\t<span class="small"><%=found%>\n\t<span class="remove btn-round last">×</span>\n\t</span>\n</div>\n'}),function(a){a("templates/templates",["underscore","text!templates/dirtree.tpl","text!templates/dirtree_error.tpl","text!templates/dirs.tpl","text!templates/newdir.tpl","text!templates/files.tpl","text!templates/selected_compact.tpl","text!templates/selected_preview.tpl","text!templates/upload.tpl","text!templates/upload_list.tpl","text!templates/upload_list_item.tpl","text!templates/meta.tpl","text!templates/search_bar.tpl","text!templates/search_list.tpl","text!templates/search_count.tpl"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){var p={};return{dirtree:a.template(b),dirtree_error:a.template(c),dirs:a.template(d),newdir:a.template(e),files:a.template(f),selected_compact:a.template(g),selected_preview:a.template(h),upload:a.template(i),upload_list:a.template(j),upload_list_item:a.template(k),meta:a.template(l),search_bar:a.template(m),search_list:a.template(n),search_count:a.template(o)}})}(this.define),function(a,b,c,d){b("views/view_upload",["jquery","underscore","backbone","collections/col_upload","modules/mod_animate_circle","modules/mod_sysmessage","templates/templates"],function(a,b,c,d,e,f,g){var h=c.View.extend.call(function(){this.initialize.apply(this,arguments)},c.Events);h.extend=c.View.extend;var i=function(){},j=h.extend({initialize:function(){this.observable={},this.observable.children=[],this._callback=b.bind(i,this)},register:function(a,b){this.observable.parent=a,this.observable.children=b},listen:function(a){var c=this;this.on("condition",function(){b.each(c.observable._diff,function(b){b.on(a,c._callback)})})},condition:function(a){var c=this;this.observable.parent.on(a,function(){c.observable._diff=b.difference(c.observable.children,c.observable._diff),c.trigger("condition")})},setState:function(){}}),k=c.View.extend({events:{"click .send":"submit"},initialize:function(){this.collection=d.addList(),this.collection.field_id=this.options.field_id,this.collection.on("create",b.bind(this.add,this)),this._ulQueue=[]},add:function(b){var c=b.toJSON(),d;c.destination=this.options.destination,d=a(g.upload_list_item(c)),b.set("context",d),b.set("field_id",52),this.$el.append(d),d.data("circle",new e({canvas:d.find(".progress")[0],lineWidth:2,stepTime:400})),this._ulQueue.push(d)},createItem:function(a,b){this.collection.addItem(b)},_flushUlQueue:function(a){if(b.isFunction(a))while(this._ulQueue.length)a.call(this._ulQueue.pop());else this._ulQueue=[]},_flushUlItem:function(a){var c=b.indexOf(this._ulQueue,a);c>=0&&this._ulQueue.splice(c,1)},submitAll:function(){this._flushUlQueue(function(a){this.find(".send").trigger("click")})},submit:function(c){c.preventDefault();var d=a(c.target).parents().filter("tr"),e=d[0].id.split("send-")[1],f=this.collection.get(e);f.on("progress",b.bind(this.progress,this,f.get("context").data("circle"))),this.collection.send(e),this._flushUlItem(f.get("context"))},progress:function(a,b){a.animate(b)}}),l=function(){function l(a){this.trigger("remove",a),this.$el.remove()}function k(){var a=this.$el.data();this.$el.addClass("error"),a.progressIndicator.clearAnimation(),a.progressIndicator.drawFullCircle([235,99,71])}function j(){var a=this.$el.data();this.trigger("success",this.model,this._upld.resolve()),a.progressIndicator.animate(99),setTimeout(function(){a.progressIndicator.animate(100)},a.progressIndicator.settings.stepTime),a.progressValue.html("100&#160;%")}function i(a,b){a.progressIndicator.animate(b||0),a.progressValue.html(b?b+"&#160;%":"")}function h(){var a="."+b.toArray(arguments).join(", .");this.$el.find(a).toggleClass("disabled")}function f(){var a=g.upload_list_item(this.model.toJSON());this.undelegateEvents(),this.setElement(a)}function d(a){return new e({canvas:a,lineWidth:6,stepTime:250})}return c.View.extend({events:{"click.item .remove":"remove","click.item .start:not(.disabled)":"submit","click.item .cancel:not(.disabled)":"cancel"},initialize:function(){var c=this.model;this.model.on("change:file",b.bind(this.update,this)),this.model.on("success",b.bind(j,this)),this.model.on("error",b.bind(k,this)),this.model.on("destroyed",b.bind(l,this)),this._upld=a.Deferred()},update:function(a){var b=this.$el.find(".file-name");this.$el.addClass("success"),b.text(this.model.get("name")),h.call(this,"cancel")},render:function(){this._parent=this.$el,f.call(this),this.$el.data("progress-indicator",d(this.$el.find(".progress")[0])),this.$el.data("progress-value",this.$el.find(".progress-text")),this.model.set("context",this._parent),this._parent.append(this.$el)},submit:function(a){a.stopPropagation(),a.preventDefault(),this.$el.data(""),this.model.on("progress",b.bind(i,this,this.$el.data())),this.trigger("upload",this.model,this._upld.promise()),h.call(this,"cancel","start")},cancel:function(a){a.stopPropagation(),a.preventDefault(),this.trigger("cancel",this.model,this._upld.reject()),h.call(this,"cancel","start"),this.$el.removeClass("success error"),i.call(this,this.$el.data(),0)},remove:function(a){a.stopPropagation(),a.preventDefault(),this.cancel(a),this.model.collection.remove(this.model)}})}(),m=function(){function r(){}function q(){}function p(a){var c=this,d=a.split(" "),e=this.collection,f=function(){var a={};b.each(d,function(b){a[b]=c.$el.find("."+b)});return a}();e.on("flush push",function(){e.models.length?f.remove.removeClass("disabled"):f.remove.addClass("disabled"),e.hasPendingUploads()?f.start.removeClass("disabled"):f.start.addClass("disabled"),e.hasActiveUploads()?f.cancel.removeClass("disabled"):f.cancel.addClass("disabled")})}function o(){this.trigger("fileuploaded")}function n(a,b){this.collection.cancel(b.id)&&(this._ulQueue.push(a),this.trigger("cancel"))}function m(a){this.collection.send(a.id).fail(function(a){new f(null,a)}).done(function(a){var b={success:{message:f.file_upload_success,context:{file:a[0].name}}};new f(null,b)}),this.trigger("start")}function k(b){var c=a(b.target),d=c.clone();i(d),c.after(d),c.detach(),this.collection.addItem(c)}function j(a){this._ulQueue.push(a)}function i(b){var c=a("<form/>").append(b);c[0].reset();return b}function h(a){var c=b.indexOf(this._ulQueue,a);c>=0&&(this._ulQueue.splice(c,1),this.trigger("flushed"))}function e(a,c){if(b.isFunction(a))while(this._ulQueue.length)a.call(this._ulQueue.pop());else this._ulQueue=[];b.isFunction(c)&&c()}return c.View.extend({events:{"click .cancel:not(.small):not(.disabled)":"cancelAll","click .remove:not(.small):not(.disabled)":"removeAll","click .start:not(.small):not(.disabled)":"submitAll","click .close":"close","change input[type=file]":k},initialize:function(){this.collection=d.addList(),this.collection.on("create",b.bind(this.add,this)).on("invalidtype",b.bind(q,this)).on("filesizeexceeds",b.bind(r,this)),this._ulQueue=[]},render:function(c){var d=g.upload_list(b.extend(c.toJSON(),{destination:this.options.destination}));this._parent=this.$el,this.undelegateEvents(),this.setElement(d,!0),this._parent.append(this.el),this._listcontainer=a("#upload-container-"+c.id),p.call(this,"remove start cancel")},add:function(a){var c;a.set("field_id",this.options.field_id),c=new l({model:a,el:this._listcontainer||"#upload-container-"+a.id}),c.render(),this._ulQueue.push(c),a.on("success",b.bind(h,this,c)).on("success",b.bind(o,this,c)),c.on("cancel",b.bind(n,this,c)),c.on("upload",b.bind(h,this,c)),c.on("upload",b.bind(m,this)),this.trigger("add")},cancelAll:function(){this.$el.find(".file-list .cancel").trigger("click.item")},submitAll:function(){e.call(this,function(a){this.$el.find(".start").trigger("click.item")})},removeAll:function(){var a=this;this.collection.remove(this.collection.models)},close:function(a){a.stopPropagation(),a.preventDefault(),this.$el.remove(),this.trigger("remove")}})}(),n=c.View.extend({events:{"click .start-all":"start"},initialize:function(){this.files=[],this.collection=d,this.uploadList={},this._dirinstance=[]},toggleView:function(){this.$el.slideDown()},addUpload:function(a){var c=new m({el:"#uploads-"+this.cid,className:"row item upload-container",field_id:this.options.field_id,destination:a.get("path")}),d=this;c.render(a),c.on("remove",b.bind(this.collection.remove,this.collection,a.id)),c.on("remove",function(){d.collection.models.length||d.$el.slideUp()}),c.on("fileuploaded",b.bind(function(){d.trigger("fileuploaded",a)}))},render:function(){if(this._rendered)return!0;this.el.innerHTML=g.upload({id:this.cid}),this._rendered=!0},removeItem:function(){},start:function(){this.uploadList.submitAll()},createUpload:function(a){if(this.collection.get(a.id))return!1;if(this._rendered===!0)this.collection.add(a),this.addUpload(a),this.trigger("uploadcreate",a);else{this.render(),this.createUpload(a);return}this.toggleView()}});return n})}(this.Symphony,this.define,this),function(a,b){a("collections/col_directories",["jquery","underscore","backbone","collections/col_general"],function(a,c,d,e){var f={},g,h,i,j,k=/,+\s+/g;g=function(){function b(a){(a===this||a===this.get("dir"))&&this.set("selected",!1)}function a(){this.get("dir").trigger("selected",this)}return d.Model.extend({initialize:function(d,e){e.dir&&this.set({dir:e.dir},{silent:!0}),this.set({id:c.uniqueId(),selected:!1,sorting:0},{silent:!0}),this.on("change:selected",c.bind(a,this)),this.collection.on("remove",c.bind(b,this)),e.dir&&this.get("dir").on("removed",c.bind(b,this))}})}(),h=function(){return d.Collection.extend({model:g,getByFileName:function(a){a=c.isArray(a)?a:a.replace(k,",").split(",");return c.filter(this.models,function(b){return c.indexOf(a,b.get("path"))>=0})}})}(),i=function(){function j(a){var b=this,d=b.get("subdirs");d&&c.each(d,function(b){a.push(b),j.call(b,a)})}function i(a,b,d,e){var f;b===this&&(f=this.get("files"),f&&f.remove(f.models),this.get("subdirs")&&c.each(this.get("subdirs"),function(b){g.call(b,!1,a,e)}))}function g(a,b,d){d=d||{},b=this.collection||b,b.remove(this,c.extend(d,{silent:a})),this.trigger("removed")}function f(){var a=this.get("parent");!a||a.get("subdirs").push(this)}function e(){var a;!this.get("_parent")||(a=this.collection.get(this.get("_parent")),this.set("parent",a)),this.collection.off("add reset",this._setParent),delete this._setParent}function b(a,b){a.set("level",b&&b.get("level")+1||0)}function a(){this.collection.setSchemeState(this)}return d.Model.extend({defaults:{name:"",_parent:null,path:null,state:"close"},initialize:function(b,d){var e=this;this.collection.on("remove",c.bind(i,this,this.collection)),this.on("change:state",c.bind(a,this)),this.on("change:parent",c.bind(f,this)),this.set("state",this.collection.getSchemeStateByDir(this))},parse:function(a){var b;a.files&&c.isArray(a.files)&&(b=new h,b.add(a.files,{dir:this}),a.files=b);return a},getSubDirs:function(a){var b=a?[this]:[];j.call(this,b);return b},getByFileName:function(a){return this.get("files")?this.get("files").getByFileName(a):[]}})}(),j=function(){function n(a){return!!f[a]}function m(a,b,c){var d,e=a.getSubDirs(!0);b=b||{},c.directory._parent=a.get("_parent"),c.directory.id=a.id,c.directory.cid=a.cid,this.remove(e,{silent:!0}),d=this.parse(c),this.add(d,{parse:!0}),h.call(this,"__UPDATE__"),!b.silent&&this.trigger("update",this.get(a.id),"update")}function l(b,d){d=d||{},d.success=d.success||function(){},d.error=d.error||function(){};return a.ajax({type:"GET",url:this.url,dataType:"json",data:c.extend({field_id:this.settings.field_id},b),success:d.success,error:d.error})}function j(a,b,d){var e=this,f,g;if(a.directory)return j.call(this,a.directory,b);f=a.id?a.id:"dir"+c.uniqueId(),a._parent=a._parent,a.id=f,b.push(a);if(a.subdirs)while(a.subdirs.length)g=a.subdirs.shift(),g.directory._parent=f,j.call(this,g,b);return b}function h(){var a=[];c.each(c.compact(this.pluck("files")),function(b){a.push(b.models)}),d[this.cid]=c.flatten(a)}function g(){var a;f[this.cid]||(a=f[this.cid]={},c.each(this.models,function(b){a[b.get("path")]={state:"close"}}))}var d={};return e.extend({url:b.Context.get("root")+"/symphony/extension/filemanager/listing/",model:i,initialize:function(){this.cid=this.cid||"c"+c.uniqueId(),this.on("reset add update remove moved delete",c.bind(h,this))},populate:function(){this.deferred=this.fetch({data:{field_id:this.settings.field_id||0}}),this.deferred.done(c.bind(g,this))},parse:function(a){var b=this,d=j.call(this,a,[]),e=c.map(d,function(a){a=new i(a,{collection:b,parse:!0});return a});c.each(e,function(a){var b=a.get("_parent"),d=c.find(e,function(a){return a.get("id")===b});a.set({parent:d})}),this.trigger("preadd",e,"preadd");return e},setScheme:function(a){f[this.cid]=a;return this},changeScheme:function(){n(this.cid)||g.call(this)},setSchemeState:function(a,b){var c=a.get("path");f[this.cid][c]&&(f[this.cid][c].state=a.get("state")?a.get("state"):"close")},getSchemeStateByDir:function(a){return n(this.cid)&&f[this.cid][a.get("path")]?f[this.cid][a.get("path")].state:"close"},getFiles:function(){var a=d[this.cid];return a.length?a:g.call(this)&&d[this.cid]},getFileByDir:function(a,b){var d=this.getFilesByDir(b),e;if(!c.isArray(d))return d.get(a);e=c.find(d,function(b){return b.get(a)});return e},getFilesByDir:function(a){return a?this.get(a).get("files"):!1},getFileById:function(a){return c.find(d[this.cid],function(b){return b.id===a})},getByFileName:function(a){var b=this.getFiles(),d=[];c.isArray(a)||(a=a.replace(k,",").split(",")),c.each(a,function(a){var e=c.find(b,function(b){return b.get("path")===a});e&&d.push(e)});return d.length?d:undefined},updateDir:function(a,b){var d=l.call(this,{select:a.get("path")}).done(c.bind(m,this,a,b)).fail();return d},createDir:function(b,d){d=this.get(d.id)||undefined;if(!d)return!1;var e=this.url.replace(/listing\/$/,"edit/"),f={mkdir:b,within:d.get("path"),type:"create"};return a.ajax({url:e,type:"post",data:f,dataType:"json",success:c.bind(this.updateDir,this,d)})},moveItem:function(b){var c=this,d=this.get(b.source),e=this.get(b.destination),f=b.file?this.getFileById(b.file):d,g={from:f.get("path"),to:e.get("path"),type:"move",dataType:b.type},h=this.url.replace(/listing\/$/,"edit/");return a.ajax({url:h,type:"post",data:g,dataType:"json",success:function(){b.type==="file"?(f.collection.remove(f),c.trigger("moved",d)):c.remove(d),c.updateDir(e)},error:function(){}})},searchFiles:function(a,b,c){var e,f=[],g=0,h,i=new RegExp(a,"i");if(!a||a.length<(c||3))return f;b=b||"file",e=d[this.cid],h=e.length;for(;g<h;g++){if(!e||!i.test(e[g].get(b)))continue;f.push(e[g])}return f},deleteItem:function(b,c){var d=this.url.replace(/listing\/$/,"edit/"),e=this,f,g=a.Deferred();c!=="file"?this.trigger("beforedirectorydelete",g):g.resolve();return a.ajax({url:d,type:"post",data:{type:"delete",file:b.get("path")},dataType:"json",success:function(){c!=="file"?e.remove(b):b.collection.remove(b),c==="file"&&e.trigger("filedelete",b),e.trigger("itemdelete",b.get("id"),c),e.trigger("delete",c==="file"?b.get("dir"):b.get("parent"))},error:function(){}})}})}();return j})}(this.define,this.Symphony),function(a,b){a("modules/mod_helper",["jquery","underscore"],function(a,c){var d=/(jpe?g|gif|tif?f|bmp|png)/,e="/workspace",f="/extensions/filemanager/assets/images/file-preview.png",g=b.Context.get("root"),h="/image/2/40/40/5";return{getThumbURL:function(a,b){var c=d.test(a.get("extension").toLowerCase())?(b||h)+a.get("src").substr((g+e).length):f;return g+c},isjQueryObject:function(b){return b instanceof a&&b.length}}})}(this.define,this.Symphony),function(a,b,c){c("views/view_directories",["jquery","underscore","backbone","collections/col_directories","templates/templates","modules/mod_sysmessage","modules/mod_byteconverter","modules/mod_helper"],function(c,d,e,f,g,h,i,j){var k,l,m,n,o,p={},q=b.Context.get("root");k=function(){function p(a){this.field.parent().removeClass("active"),c(document).off("keyup.searchlist")}function o(a){this.field.parent().addClass("active"),c(document).on("keyup.searchlist",d.bind(l,this))}function n(a){var b=c("#result-"+a.id);b.length&&b[a.get("selected")?"addClass":"removeClass"]("selected")}function m(){l.call(this,{keyCode:27})}function l(a){a.keyCode===27&&(this.reset(),this.field.val("").blur())}function k(e){var i,j,k;a++,this.reset(),f=this.options.threshold,this.options.threshold=0,a=0,i=e.target,j=this.collection.searchFiles(i.value),k=j.length,this.counter=c(g.search_count({found:b.Language.get(h[k===1?"count_file_found":"count_files_found"],{count:k})})),d.each(j,d.bind(this.render,this)),this.field.after(this.counter)}function i(a){a.preventDefault();var b=c([c(a.target),c(a.target).parents().filter("li")]).filter(function(){return this.hasClass("result-item")}),d;d=b[0][0].id.replace(/result/,"file"),b.addClass("selected");var e=this.collection.getFileById(parseInt(d.substr(5),10));e.set("selected",!0)}var a=0,f;return e.View.extend({events:{"click.searchlist .result-item:not(.selected)":i,"focus.searchlist input[type=text]":o,"blur.searchlist input[type=text]":p,"click.searchlist .remove":m,"keyup.searchlist input[type=text]":k},initialize:function(){this.template=g.search_list,this.list=this.$el.find(".results"),this.field=this.$el.find("input[type=text]"),this.collection.on("selected",d.bind(n,this))},reset:function(){this.options.threshold=f,this.list.empty(),this.counter&&this.counter.remove()},render:function(a){var b=a.toJSON(),c;b.thumb=j.getThumbURL(a,"/image/2/40/40/5"),c=this.template(b),this.list.append(c)}})}(),n=function(){function b(a){a==="add"?this.$el.addClass("file-selected"):a==="remove"&&this.$el.removeClass("file-selected")}function a(a){a.preventDefault(),a.stopPropagation(),this.close()}return e.View.extend({events:{"click.meta .close":a},initialize:function(){var a;this._rendered=!1,this.$el.on("destroyed",d.bind(this.remove,this)),a=d.bind(b,this),this.options.parentView.on("select",a).on("unselect",a)},render:function(){var a,b;if(this._rendered)return this;a=d.extend(this.model.toJSON(),{preview:j.getThumbURL(this.model,"/image/1/0/150"),size:i(this.model.get("size"))+" ("+this.model.get("size")+")"}),b=g.meta(a),this.el.innerHTML=b,this._rendered=!0;return this},open:function(a){var d=this,e=c("#file-"+this.options.parentView.model.id);if(!this._rendered){this.render(),this.open(a);return this}this.$el.insertAfter(e),this.delegateEvents(),a?this.$el.css({display:"block"}):this.$el.slideDown(),this._open=!0,this.trigger("open",this),e.hasClass("selected")?b.call(this,"add"):this.options.parentView.model.get("selected")&&b.call(d,"add");return this},close:function(a){var b=this;this._open=!1,this.$el.slideUp(function(){a?b.$el.remove():b.undelegateEvents()}),!a&&this.trigger("close",this)},remove:function(){this.undelegateEvents(),this.trigger("remove")}})}(),n.makeView=function(){if(this instanceof e.View)return new n({parentView:this,tagName:"li",model:this.model,id:"meta-for-"+this.model.id,className:"meta-view",idPrefix:"meta-for-"});throw"makeView called with wrong context"},l=function(){function a(a){var b,c;a===this.model&&this._metaView&&(b=this._metaView,c=a.get("dir").get("path"),this._metaView.close(!0))}return e.View.extend({initialize:function(){this.model.collection.on("remove",d.bind(a,this))},render:function(a){a=a||{};var b=this,c=g.files(d.extend(this.model.toJSON(),{settings:a}));this.el.innerHTML+=c,setTimeout(function(){b.$el.find("#preview-"+b.model.id).on("click.file",d.bind(b.showMetaInfo,b))},0)},setMetaView:function(){var a=this.model.get("path"),b=this.dirView,c;this._metaView||(c=b.model.collection.cid,this._metaView=n.makeView.call(this),this._metaView.on("open",function(){p[c][a]=!0}).on("close",function(){delete p[c][a]}))},showMetaInfo:function(a){a.preventDefault(),a.stopPropagation(),this.setMetaView(),this._metaView.open()}})}(),m=function(){function f(){var b={},c=this.$el.find(".toolbar:first");d.each(a,function(a){var d=c.find("."+a);d.length&&(b[a]=d)}),this._tasks=b}function c(a,b){this._tasks[a]&&this._tasks[a].addClass("disabled")}function b(a,b){this._tasks[a]&&this._tasks[a].removeClass("disabled")}var a="upload create move delete".split(" ");return e.View.extend({events:{},initialize:function(){var a=this;this.fileViews=[],this._files={},this.on("enabletask",d.bind(b,this)).on("disabletask",d.bind(c,this))},render:function(a,b,c){var e=this,h=d.clone(a),i,j=this.model.get("parent"),k=this.model.get("files"),m;this.$el.html(g.dirs(d.extend(this.model.toJSON(),{settings:d.extend(h,b)}))),m=this.$el.find("#sub-"+this.model.id),k&&(k.on("remove",d.bind(e.model.collection.trigger,e.model.collection,"remove")),k.each(function(a){var c=new l({el:m,model:a});c.dirView=e,e._files[a.get("path")]=c,e.fileViews.push(c),c.render(b)})),i=j?document.getElementById("sub-"+j.id):document.getElementById("dir-list-root-"+this.model.collection.cid),i&&!c&&this.$el.appendTo(i),f.call(this),this.model.get("state")==="open"&&this.$el.addClass(this.model.get("state")),c&&this.trigger("update",this)},getFileViewById:function(a){var b;a=isNaN(a)?parseInt(a.replace("file-",""),10):a,b=d.find(this.fileViews,function(b){return b.model.id===a});return b},getFileByPath:function(a){return this._files[a]},getSubDirs:function(){var a=this.model.get("subdirs")}})}(),o=function(){function C(a){var b=new h(null,a),c=g.dirtree_error({message:b.getMessage()});this.el.innerHTML=c}function B(a){var b=d.keys(p[this.collection.cid]),c,e=this,f,g=[],h=this.getDirViewByModel(a);!b.length||d.each(b,function(a){var b=e.collection.getByFileName(a),c=e.getFileViewByModel(b[0]);c&&(c.setMetaView(),c._metaView.open(!0))})}function A(){this.$el.find(".draggable:not(.ui-draggable)").trigger("mouseenter").end().find(".droppable:not(.ui-droppable)").trigger("mouseenter")}function z(){var a=this,b=this.$el.find(".droppable:not(.ui-droppable)");b.droppable({drop:d.bind(s,this),greedy:!0,tolerance:"intersect",hoverClass:"dropover",scope:"moveable",over:function(d,e){b.on("toggleopen.itemdraggover",function(){var b=c(this),d=b.parent();y(b,d,a)}),setTimeout(function(){b.trigger("toggleopen.itemdraggover",[d,e])},600)},out:function(a,c){b.off("toggleopen.itemdraggover")}}),b.on("destroyed",w);return this}function y(a,b,c){b.hasClass("open")||(a.on("dropout.itemdraggover",function(a,d){c.closeDir(b)}),c.openDir(b))}function x(){var a=this.$el.find(".draggable:not(.ui-draggable)");a.draggable({revert:!0,revertDuration:120,cursor:"move",axis:"y",handle:".move",opacity:.7,snap:!0,zIndex:2700,scope:"moveable"}),a.on("destroyed",v);return this}function w(){c(this).droppable("destroy")}function v(){c(this).draggable("destroy")}function u(a){a.preventDefault(),a.stopPropagation();var b;if(!!/droppable/.test(a.target.className)){b=c(a.target).add(".droppable"),b.droppable({drop:d.bind(s,this),greedy:!0,tolerance:"intersect",hoverClass:"dropover",scope:"moveable"});return this}}function t(a){a.preventDefault(),a.stopPropagation();var b;if(!!/draggable/.test(a.target.className)){b=c(a.target),b.draggable({revert:!0,revertDuration:120,cursor:"move",axis:"y",handle:".move",opacity:.7,snap:!0,zIndex:2700,scope:"moveable"});return this}}function s(a,b){a.preventDefault(),a.stopPropagation();var d=b.draggable,e=/file/.test(d[0].className)?"file":"dir",f=c(a.target).parent()[0].id,g=e==="file"?d.parents().filter("li.dir")[0].id:d.parent()[0].id,i=e==="file"?d[0].id.substr(5):undefined;this.collection.moveItem({type:e,destination:f,source:g,file:e==="file"?parseInt(i,10):i}).always(function(a){new h(null,a)})}function r(a){a=a instanceof e.Model?a:this.collection.get(a.directory.id);return this.renderPart(a)}function q(a,b){var c=b.find("input[type=text]").val();this.collection.createDir(c,a).always(function(a){b.off("click",".confirm"),b.remove();var c=new h(null,a)})}function o(a,b,c){var d=/dir/.test(a.id);d||this.trigger("select","remove",a);return n.call(this,a.id,d?"dir":"file")}function n(a,b){if(!this instanceof e.View)throw"function called with wrong context";var d=b==="file"?c("#file-"+a):c("#"+a),f=c([d,d.find(".dir-header")]).filter(function(){return this.data("draggable")||this.data("droppable")});this.dirViews[a]&&delete this.dirViews[a],d.detach(),setTimeout(function(){d.remove()},100);return this}function l(a){this[a.get("selected")?"selectById":"unselectById"](a.id)}function i(a,b){var c=this.collection.getFileById(parseInt(a.target.id.replace("select-file-",""),10)),d=b==="add"?"select":"unselect",e=b==="add"?!0:!1;this.trigger("select",b,c.toJSON()),c.set("selected",e)}return e.View.extend({events:{"click.dritree .toolbar":"tasks","click.dirtree .dir-header":"toggleDir","click.dirtree .file:not(.selected) > .text":"select","click.dirtree .file.selected > .text":"unselect","click.dirtree .file > .toolbar > .delete":"deleteFile","click.dirtree .dir-header > .toolbar > .delete":"deleteDir","click.dirtree .dir-header > .toolbar > .create":"createDir"},initialize:function(){this.collection=new f,this.dirViews={},this.collection.addSetting("field_id",this.options.field_id),this.collection.populate(),this.collection.deferred.done(d.bind(this.render,this)).fail(d.bind(C,this)),this.collection.on("add",d.bind(this.renderPart,this)),this.collection.on("remove",d.bind(o,this)),this.collection.on("update",d.debounce(d.bind(B,this),0)),this.collection.on("selected",d.bind(l,this)),p[this.collection.cid]={},this.searchView=new k({el:g.search_bar({id:"search-"+this.cid}),threshold:3,collection:this.collection}),this.$el.parent().find("label").after(this.searchView.$el),a["tree"+this.cid]=this},tasks:function(a){var b=c(a.target).parents().filter("li").find("ul")[0].id.substr(4),d=a.target.className.split(" ")[1];this.trigger(d,this.collection.get(b));return!1},select:function(a){i.call(this,a,"add")},unselect:function(a){i.call(this,a,"remove")},selectById:function(a){this.filesById(a).addClass("selected");return this},unselectById:function(a){this.filesById(a).removeClass("selected");return this},filesById:function(a){return c(d.isArray(a)?"#file-"+a.join(", #file-"):"#file-"+a)},getFile:function(a){return this.collection.getFileById(parseInt(a[0].id.split("file-")[1],10))},confirm:function(a){return confirm(a)},deleteDir:function(a){var d=this.collection.get(c(a.target).parents().filter(".dir")[0].id),e=b.Language.get(h.confirm_directory_deletion,{dir:d.get("name"),dir2:d.get("name"),dircount:d.get("subdirs")?d.get("subdirs").length:0,filecount:d.get("files")?d.get("files").models.length:0});this.confirm(e)&&this.collection.deleteItem(d,"dir").always(function(a){new h(null,a)})},deleteFile:function(a){var d=c(a.target),e=d.parents().filter(".file"),f=e.parent(),g=this.getFile(e),i=b.Language.get(h.confirm_file_deletion,{file:g.get("name")||g.get("path")});this.confirm(i)&&this.collection.deleteItem(g,"file").always(function(a){new h(null,a)}).done(function(){g.get("selected")&&g.set("selected",!1)})},createDir:function(a){var b=c(a.target),e=this.collection.get(b.parents().filter(".dir")[0].id),f=c(g.newdir({parent:e.get("path"),level:~~e.get("level")+1}));c("#sub-"+e.id).prepend(f),this.openDir(b.parents().filter(".dir")),f.on("click",".add",d.bind(q,this,e,f)),f.on("click",".cancel",function(){f.remove()})},toggleDir:function(a){var b,d,e,f,e;a.preventDefault(),a.stopPropagation(),b=c(a.target).parents().filter(".dir:not(#dir-list-root-"+this.collection.cid+")").first(),d=b.find("> .sub-dir"),f=b.hasClass("open")?"close":"open",e=f==="open"?"openDir":"closeDir",this[e](b)},openDir:function(a){j.isjQueryObject(a)&&(a.find("> .sub-dir").slideDown(),a.addClass("open"),this.collection.get(a[0].id).set("state","open"))},closeDir:function(a){a.find("> .sub-dir").slideUp(),a.removeClass("open"),this.collection.get(a[0].id).set("state","close")},enableTask:function(a,b){this.dirViews[b.id].trigger("enabletask",a)},disableTask:function(a,b){this.dirViews[b.id].trigger("disabletask",a)},renderPart:function(a){var b,c=this.dirViews[a.id]?!0:!1;c?(b=this.dirViews[a.id],b.model=a):(b=new m({tagName:"li",id:a.id,className:"dir level-"+a.get("level"),model:a}),this.dirViews[a.id]=b),b.render(this.options.dirSettings,this.options.fileSettings,c),c&&d.isArray(a.get("subdirs"))&&d.each(a.get("subdirs"),d.bind(r,this)),c&&this.trigger("update",b),x.call(this),z.call(this)},render:function(){var a=this;this.el.innerHTML=g.dirtree({name:this.options.baseName,cid:this.collection.cid}),this.collection.each(d.bind(this.renderPart,this))},getSubdirsFromView:function(a,b){var c=this,e=a.model.get("subdirs"),f=[];e&&d.each(e,function(a){c.dirViews[a.id]&&(f.push(c.dirViews[a.id]),b&&a.get("subdirs")&&f.push.apply(f,c.getSubdirsFromView(c.dirViews[a.id],!0)))});return f},getDirViewByModel:function(a){return this.dirViews[a.id]},getDirViewById:function(a){return this.dirViews[a]},getFileViewByModel:function(a){var b=this.getDirViewById(a.get("dir").id),c=b.getFileViewById(a.id);return c}})}();return o})}(this,this.Symphony,this.define),function(a){a("collections/col_select",["underscore","collections/col_general"],function(a,b){function f(a,b){var c=a.length,d=b.length,e=0;if(c!==d)return!0;for(;e<c;e++)if(a[e]!==b[e])return!0;return!1}function e(){var a=c[this.cid];a.push((new Date).getTime())}var c={},d=b.prototype.constructor.prototype.add,g=b.extend({initialize:function(){this.cid="c"+a.uniqueId(),c[this.cid]=[]},record:function(){c[this.cid]=this.pluck("path")},comparator:function(a){return a.get("sorting")},getDiff:function(){var a=this.pluck("path");return f(c[this.cid],a)},add:function(b){var c=a.isArray(b),e=c?b.length:1,f=this.models.length+e,g;if(this.settings.limit&&f>this.settings.limit){g=a.isArray(b)?a.pluck(b,"id"):b.id,c?a.each(b,function(a){a.set("selected",!1)}):b.set("selected",!1),this.trigger("selectionlimitexceed",g);return!1}return d.apply(this,arguments)},hasChanges:function(){return!!c[this.cid].length}});return g})}(this.define),function(a,b,c){var d=0,e=b.Context.get("root");a("views/view_select",["jquery","underscore","backbone","collections/col_select","modules/mod_sysmessage","modules/mod_helper","templates/templates"],function(a,b,c,d,e,f,g){function n(b,c){var d=c.index(),e=this;m.call(this,c),c.siblings().each(function(){m.call(e,a(this))}),this.collection.sort({silent:!0})}function m(a){var b=parseInt(a[0].id.replace("item-",""),10),c=a.index();this.collection.get(b).set({sorting:c},{silent:!0})}function l(a){}function k(a){this.collection[a.get("selected")?"add":"remove"](a)}function j(){}function i(){var a={error:{message:e.file_select_limit_exceed,context:{count:this.collection.settings.limit}}};return new e("error",a,!1)}function h(b){var c=a(this),d=c.find(".ordering"),e=d.offset().left,f=e+d.outerWidth(),g=b.pageX,h,i;window.getSelection&&window.getSelection().removeAllRanges(),g<e?(h=d.prev("li"),h.length>0&&(d.insertBefore(h),c.trigger("orderchange",[d]))):g>f&&(i=d.next("li"),i.length>0&&(d.insertAfter(i),c.trigger("orderchange",[d])))}var o=c.View.extend({events:{"click .remove":"removeFromList"},initialize:function(){this.collection=new d,this.dirtree=this.options.dirtree,this.fieldname=this.options.fieldname,this.dirtree.collection.on("selected",b.bind(k,this)),this.collection.on("add",b.bind(this.addItem,this)).on("remove",b.bind(this.removeItem,this)).on("add remove reset",b.bind(this.toggleState,this)),this.collection.on("selectionlimitexceed",b.bind(i,this)),this.template=this.options.mode==="compact"?g.selected_compact:g.selected_preview,this.label=this.$el.parent().find(".section-head"),this.$el.addClass(this.options.mode),this.options.sortable&&(this.$el.symphonyOrderable(),this.options.mode==="compact"&&this.$el.parent().on("mousemove.orderable",".ordering:has(.ordering)",h),this.$el.on("orderstop.orderable",b.bind(n,this))),this.prePopulate()},prePopulate:function(){var a=this,c=this.$el.find("input.file-selected"),d=[],e=[];e=this.dirtree.collection.deferred.done(function(){c.each(function(){var b=a.dirtree.collection.getByFileName(this.value);b&&b.length&&b[0].set("selected",!0)}),a.$el.empty(),a.collection.each(b.bind(a.addItem,a)),a.trigger("prepoulate",a.collection.pluck("id")),a.toggleState(),a.collection.record()})},toggleState:function(){this.collection.models.length?(this.$el.addClass("populated"),this.label.addClass("hidden")):(this.$el.removeClass("populated"),this.label.removeClass("hidden"))},getFiles:function(){return this.collection.pluck("path")},render:function(){var c=this,d="",e=this.template;this.collection.each(function(g){var h=g.toJSON();b.extend(h,{fieldname:c.fieldname,thumb:f.getThumbURL(g),draggable:c.options.sortable}),g.set({sorting:a("#item-"+g.id).index()},{silent:!0}),d+=e(h)}),this.el.innerHTML=d},addItem:function(c){var d=c.toJSON(),e,g;d.fieldname=this.fieldname,e=d.id,b.extend(d,{fieldname:this.fieldname,thumb:f.getThumbURL(c),draggable:this.options.sortable}),g=this.template(d),this.$el.append(g),c.set({sorting:a("#item-"+c.id).index()},{silent:!0})},removeItem:function(b){var c=b.id,d=a("#item-"+b.id);d.remove();return!0},removeFromList:function(a){var b=parseInt(a.target.id.split("remove-")[1],10),c=this.collection.get(b);c&&c.set("selected",!1)}});return o})}(this.define,this.Symphony,this.jQuery.noConflict()),function(a){a("modules/mod_syncmanager",["underscore","backbone"],function(a,b){var c=a.extend({collections:[],_callback:function(a){this.off(c.events,c._callback),c.syncDirs(this,a),this.on(c.events,c._callback)},events:"update delete moved filedelete",syncDirs:function(b,d){a.each(this.collections,function(e){var f,g=d.get("path"),h;e!==b&&(h=a.indexOf(e.pluck("path"),g),f=h>=0?e.models[a.indexOf(e.pluck("path"),g)]:null,f&&(e.off(c.events,c._callback),e.updateDir(f,{silent:!1}).always(function(){e.on(c.events,c._callback)})))})},add:function(d){if(a.isArray(d)){a.each(d,a.bind(c.add,c));return this}if(d instanceof b.Collection){this.collections.push(d),this.trigger("add",d,this);return this}throw"can't add none collection Objects"},removeCollection:function(b){if(a.isArray(b)){a.each(b,a.bind(c.removeCollection,c));return this}var d=a.indexOf(this.collections,b);d>=0&&this.collection.splice(d,1);return this}},b.Events);return c})}(this.define),function(a,b){typeof a=="function"&&a.amd?a("plugins/jquery-event-destroyed",["jquery"],b):b(this.jQuery)}(this.define,function(a){var b=jQuery.cleanData;a.cleanData=function(c){for(var d=0,e;(e=c[d])!==undefined;d++)a(e).triggerHandler("destroyed");b(c)}}),function(a,b,c){var d=jQuery;c(["fm_settings","jquery","underscore","backbone","views/view_upload","views/view_directories","views/view_select","modules/mod_sysmessage","modules/mod_syncmanager","jqueryui","plugins/jquery-event-destroyed","orderable"],function(a,c,e,f,g,h,i,j,k){function p(){return this}var l,m,n,o=!1;c.noConflict(),f.noConflict(),e.noConflict(),window.jQuery=d.noConflict(),typeof c.fn.symphonyOrderable!="function"&&typeof d.fn.symphonyOrderable=="function"&&(c.fn.symphonyOrderable=d.fn.symphonyOrderable),f.emulateHTTP=!0,p.prototype={url:a.root+"/symphony/extension/filemanager/settings/",get:function(a){return c.ajax({url:this.url,data:{field_id:a}})}},e.each(a.instances,function(a){a.deferred=(new p).get(a.field_id)}),c(function(){var d=c("form"),f=function(){var a=d.serialize();c.ajax({type:"POST",url:d.attr("action"),data:a})};e.each(a.instances,function(a,l){var m=c("#"+l),n=c("#filemanager-container-"+a.instance),p=c("#filemanager-files-select-container-"+a.instance),q,r,s;m.addClass("loading"),a.deferred.done(function(b){var d={},f={};e.each(b,function(a,b){b.match(/^allow_dir_/)&&(d[b]=a)}),e.each(b,function(a,b){b.match(/^allow_file_/)&&(f[b]=a)}),q=new h({el:"#filemanager-dir-listing-body-"+a.instance,tagName:"ul",className:"root-dir dir",dirSettings:d,fileSettings:f,field_id:b.field_id,baseName:b.element_name}),k.add(q.collection),q.collection.on(k.events,k._callback),r=new i({dirtree:q,el:p.find("ul").get(0),fieldname:b.element_name,mode:b.display_mode,sortable:b.allow_sort_selected}),b.allow_dir_move&&q.$el.addClass("draggable"),b.limit_files&&r.collection.addSetting("limit",parseInt(b.limit_files,10)),b.allow_dir_upload_files&&(s=new g({el:"#filemanager-fileupload-"+a.instance,field_id:b.field_id}),s.collection.addSetting("allowed_types",new RegExp(b.allowed_types),!0),s.collection.addSetting("max_file_size",b.max_upload_size),s.collection.addSetting("field_id",b.field_id),s.on("uploadcreate",e.bind(q.disableTask,q,"upload")),s.on("uploaddestroy",e.bind(q.enableTask,q,"upload")),s.on("fileuploaded",e.bind(q.collection.updateDir,q.collection)),q.on("upload",e.bind(s.createUpload,s)).on("toggle",function(){})),q.collection.on("update",function(a){var b=r.collection.pluck("path"),c=q.collection.getByFileName(b);r.collection.reset(c),e.each(c,function(a){a.set("selected",!0)}),r.render()}),r.collection.on("selectionlimitexceed",q.unselectById),q.collection.deferred.always(function(){m.removeClass("loading"),n.slideDown()}),c(window).on("beforeunload.getdiff",function(){r.collection.getDiff()&&(o=!0)})});var t=e.debounce(function(){c(window).on("beforeunload.filemanager",function(){if(o){f();return b.Language.get(j.unsaved_changes)}})},100);d.on("submit.filemanager",function(){c(window).off("beforeunload.filemanager")}),t()})})})}(this.jQuery.noConflict(),this.Symphony,this.require),define("main",function(){})